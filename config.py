"""
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–≤–∏–∑-–±–æ—Ç–∞: –∑–æ–Ω—ã, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã, –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
"""

from typing import Dict, List
from dataclasses import dataclass

# ========================================
# –ó–û–ù–´ –ò –ò–• –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò
# ========================================

Zone = str  # "product" | "traffic" | "content" | "sales" | "system"

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –±–∞–ª–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∑–æ–Ω—ã
ZONE_MAX: Dict[Zone, int] = {
    "product": 2,
    "traffic": 2,
    "content": 2,
    "sales": 3,      # –£ –ø—Ä–æ–¥–∞–∂ –º–æ–∂–µ—Ç –±—ã—Ç—å "–∂–∏—Ä–Ω–∞—è –±–æ–ª—å" = 3
    "system": 2,
}

# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ –±–∞–ª–ª–æ–≤ (—Ç–∞–π-–±—Ä–µ–π–∫)
# –ü–µ—Ä–≤—ã–µ –∑–æ–Ω—ã –≤–∞–∂–Ω–µ–µ ‚Äî –µ—Å–ª–∏ —Ä–∞–≤–Ω—ã –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –±–∞–ª–ª—ã, –≤—ã–±–∏—Ä–∞–µ–º –ø–æ —ç—Ç–æ–º—É –ø–æ—Ä—è–¥–∫—É
ZONE_PRIORITY: List[Zone] = [
    "product",   # –û—Ñ—Ñ–µ—Ä/–ø—Ä–æ–¥—É–∫—Ç ‚Äî —á–∞—â–µ –≤—Å–µ–≥–æ —Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–∫–∞
    "sales",     # –ü—Ä–æ–¥–∞–∂–∏ ‚Äî –≤—Ç–æ—Ä–∞—è –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏
    "traffic",   # –¢—Ä–∞—Ñ–∏–∫
    "content",   # –ö–æ–Ω—Ç–µ–Ω—Ç/–¥–æ–≤–µ—Ä–∏–µ
    "system",    # –°–∏—Å—Ç–µ–º–∞/—Ä–µ—Å—É—Ä—Å
]

# –ù–∞–∑–≤–∞–Ω–∏—è –∑–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
ZONE_LABEL: Dict[Zone, str] = {
    "product": "–ü—Ä–æ–¥—É–∫—Ç/–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ",
    "traffic": "–¢—Ä–∞—Ñ–∏–∫",
    "content": "–ö–æ–Ω—Ç–µ–Ω—Ç/–¥–æ–≤–µ—Ä–∏–µ",
    "sales": "–ü—Ä–æ–¥–∞–∂–∏",
    "system": "–°–∏—Å—Ç–µ–º–∞/—Ä–µ—Å—É—Ä—Å",
}

# –ü–æ—Ä–æ–≥ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ç–≤–∏—Å—Ç–∞ (—Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É bottleneck –∏ perceived)
TWIST_THRESHOLD = 0.2

# ========================================
# –ü–õ–ï–ô–°–•–û–õ–î–ï–†–´ –î–õ–Ø WHITE-LABEL
# ========================================

@dataclass
class TemplateVars:
    """–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —à–∞–±–ª–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    expert_name: str = "–ú–∞—Ä–∏–Ω–∞"         # –ò–º—è —ç–∫—Å–ø–µ—Ä—Ç–∞ (–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂)
    expert_name_dat: str = "–ú–∞—Ä–∏–Ω–µ"     # –î–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂ ("–∏–¥—É –∫...")
    pronoun_dat: str = "–µ–π"             # –ú–µ—Å—Ç–æ–∏–º–µ–Ω–∏–µ –¥–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂ ("–Ω–∞–ø–∏—à–∏ –µ–π")
    product: str = "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é"       # –ü—Ä–æ–¥—É–∫—Ç: –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è/–≥—Ä—É–ø–ø–∞/–∫—É—Ä—Å
    code_word: str = "–†–ê–ó–ë–û–†"           # –ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è —Å–≤—è–∑–∏


# –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ .env)
DEFAULT_TEMPLATE = TemplateVars(
    expert_name="–ú–∞—Ä–∏–Ω–∞",
    expert_name_dat="–ú–∞—Ä–∏–Ω–µ",
    pronoun_dat="–µ–π",
    product="–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é",
    code_word="–†–ê–ó–ë–û–†"
)


# ========================================
# –¢–ï–ö–°–¢–´ –î–õ–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
# ========================================

def build_twist_message(
    bottleneck_name: str,
    perceived_name: str,
    vars: TemplateVars
) -> str:
    """
    –°–æ–æ–±—â–µ–Ω–∏–µ —Å –¢–í–ò–°–¢–û–ú (–∫–æ–≥–¥–∞ perceived != bottleneck)
    """
    return (
        f"üîç <b>–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —à—Ç—É–∫–∞...</b>\n\n"
        f"–ü–æ —Ç–≤–æ–∏–º –æ—Ç–≤–µ—Ç–∞–º —è –≤–∏–∂—É, —á—Ç–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Ç–µ–±—è —Ç—Ä–µ–≤–æ–∂–∏—Ç <b>{perceived_name}</b>.\n\n"
        f"–ù–æ –ø–æ —Å—É–º–º–µ ¬´—Ç–æ—á–µ–∫ –ø–æ—Ç–µ—Ä—å¬ª –≥–ª–∞–≤–Ω—ã–π —Å—Ç–æ–ø–æ—Ä —Å–µ–π—á–∞—Å ‚Äî <b>{bottleneck_name}</b>.\n\n"
        f"üéØ <b>–¢–≤–æ–π –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ö–∏—Ç–∏—Ç–µ–ª—å X100 ‚Äî {bottleneck_name}</b>\n\n"
        f"‚ö†Ô∏è <b>–¶–µ–Ω–∞ –æ—à–∏–±–∫–∏:</b>\n"
        f"–ï—Å–ª–∏ –±—É–¥–µ—à—å —á–∏–Ω–∏—Ç—å –Ω–µ —ç—Ç–æ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ, —Ç–æ –ø—Ä–æ—Å—Ç–æ –±—ã—Å—Ç—Ä–µ–µ —É—Å—Ç–∞–Ω–µ—à—å, "
        f"–Ω–æ –Ω–µ –≤—ã—Ä–∞—Å—Ç–µ—à—å. –≠—Ç–æ –∫–∞–∫ –∫–∞—á–∞—Ç—å –≤–æ–¥—É –≤ –±–æ—á–∫—É —Å –¥—ã—Ä–∫–æ–π ‚Äî "
        f"–æ—â—É—â–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –µ—Å—Ç—å, –∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ —É –∑–∞—Ä—è–¥–∫–∏ –±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞: "
        f"–≤—Ä–æ–¥–µ –ø—Ä–æ—Ü–µ—Å—Å –∏–¥—ë—Ç, –ø–æ–ª—å–∑—ã –Ω–æ–ª—å üôÇ\n\n"
        f"üí° {vars.expert_name} –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–≤–æ—é —Å–∏—Ç—É–∞—Ü–∏—é –∏ –¥–∞—Å—Ç –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω.\n"
        f"–ù–∞–ø–∏—à–∏ {vars.pronoun_dat} –≤ –ª–∏—á–∫—É –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ <b>¬´{vars.code_word}¬ª</b>"
    )


def build_confirmation_message(
    bottleneck_name: str,
    vars: TemplateVars
) -> str:
    """
    –°–æ–æ–±—â–µ–Ω–∏–µ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø (–∫–æ–≥–¥–∞ perceived == bottleneck)
    """
    return (
        f"‚úÖ <b>–¢—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á—É–≤—Å—Ç–≤—É–µ—à—å!</b>\n\n"
        f"–ì–ª–∞–≤–Ω–æ–µ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ —Å–µ–π—á–∞—Å ‚Äî <b>{bottleneck_name}</b>.\n\n"
        f"üéØ <b>–¢–≤–æ–π –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ö–∏—Ç–∏—Ç–µ–ª—å X100 ‚Äî {bottleneck_name}</b>\n\n"
        f"üí° –•–æ—Ä–æ—à–∞—è –Ω–æ–≤–æ—Å—Ç—å: –µ—Å–ª–∏ –ø–æ–¥—Ç—è–Ω—É—Ç—å –∏–º–µ–Ω–Ω–æ —ç—Ç–æ, "
        f"–æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–æ–Ω—ã –ø–æ–µ–¥—É—Ç –∑–∞–º–µ—Ç–Ω–æ –ª–µ–≥—á–µ.\n\n"
        f"‚ö†Ô∏è <b>–¶–µ–Ω–∞ –æ—à–∏–±–∫–∏:</b>\n"
        f"–ï—Å–ª–∏ —Ä–∞—Å–ø—ã–ª—è—Ç—å—Å—è –Ω–∞ –≤—Å—ë —Å—Ä–∞–∑—É –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è "
        f"–Ω–∞ —ç—Ç–æ–º —É–∑–∫–æ–º –º–µ—Å—Ç–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –±—ã—Å—Ç—Ä–µ–µ —É—Å—Ç–∞–Ω–µ—à—å, –Ω–æ –Ω–µ –≤—ã—Ä–∞—Å—Ç–µ—à—å.\n\n"
        f"{vars.expert_name} –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–≤–æ—é —Å–∏—Ç—É–∞—Ü–∏—é –∏ –¥–∞—Å—Ç –ø–µ—Ä–≤—ã–µ 3 —à–∞–≥–∞.\n"
        f"–ù–∞–ø–∏—à–∏ {vars.pronoun_dat} –≤ –ª–∏—á–∫—É —Å–ª–æ–≤–æ <b>¬´{vars.code_word}¬ª</b>"
    )
